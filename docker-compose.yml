version: '3.8'

services:
  # Base de datos PostgreSQL
  db:
    image: postgres:15
    container_name: pos-cesariel-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-pos_cesariel}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - pos-cesariel-network

  # Adminer para administrar la base de datos
  adminer:
    image: adminer
    container_name: pos-cesariel-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - db
    networks:
      - pos-cesariel-network

  # Backend FastAPI
  backend:
    build: ./backend
    container_name: pos-cesariel-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    env_file:
      - .env  # Load environment variables from .env file
    environment:
      # Database configuration (override with .env values)
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-password}@${DB_HOST:-db}:${DB_PORT:-5432}/${DB_NAME:-pos_cesariel}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-pos_cesariel}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-password}
      # Application config
      - ENV=${ENV:-development}
      - DEBUG=${DEBUG:-true}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-insecure_dev_key_change_in_production}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES:-480}
      # Cloudinary (from .env)
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
    depends_on:
      - db
    networks:
      - pos-cesariel-network

  # Frontend Next.js (POS Admin)
  frontend:
    build: ./frontend/pos-cesariel
    container_name: pos-cesariel-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/pos-cesariel:/app
      - /app/node_modules  # Evita sobrescribir node_modules
    env_file:
      - .env
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      - WATCHPACK_POLLING=${WATCHPACK_POLLING:-true}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING:-true}
    depends_on:
      - backend
    networks:
      - pos-cesariel-network

  # E-commerce Frontend Next.js
  ecommerce:
    build: ./ecommerce
    container_name: pos-cesariel-ecommerce
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - ./ecommerce:/app
      - /app/node_modules  # Evita sobrescribir node_modules
    env_file:
      - .env
    environment:
      # Server-side URL (Docker internal network)
      - API_URL=${API_URL:-http://backend:8000}
      # Client-side URL (browser from host machine)
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      - PORT=3001
      - WATCHPACK_POLLING=${WATCHPACK_POLLING:-true}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING:-true}
    depends_on:
      - backend
    networks:
      - pos-cesariel-network

volumes:
  postgres_data:

networks:
  pos-cesariel-network:
    driver: bridge
