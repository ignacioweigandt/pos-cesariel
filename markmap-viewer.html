<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Cesariel - Mapa Visual del Sistema</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.3/dist/browser/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.3/dist/browser/index.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .markmap-container {
            width: 100vw;
            height: calc(100vh - 140px);
            background: white;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .instructions h4 {
            margin: 0 0 10px 0;
            color: #4FC3F7;
        }
        
        .instructions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
        }
        
        /* Estilos personalizados para el markmap */
        .markmap-container .markmap {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè™ POS Cesariel</h1>
        <p>Mapa Visual Interactivo del Sistema Completo</p>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="expandAll()">üîç Expandir Todo</button>
        <button class="btn" onclick="collapseAll()">üìÅ Contraer Todo</button>
        <button class="btn" onclick="resetZoom()">üéØ Centrar Vista</button>
        <button class="btn" onclick="downloadSVG()">üíæ Descargar SVG</button>
    </div>

    <div class="markmap-container" id="markmap"></div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        Cargando mapa del sistema...
    </div>
    
    <div class="instructions">
        <h4>üí° Instrucciones de Navegaci√≥n:</h4>
        <ul>
            <li><strong>Zoom:</strong> Rueda del mouse o gestos de pellizco</li>
            <li><strong>Pan:</strong> Clic y arrastrar para mover el mapa</li>
            <li><strong>Expandir/Contraer:</strong> Clic en los c√≠rculos de los nodos</li>
            <li><strong>Explorar:</strong> Cada nodo representa un componente del sistema</li>
        </ul>
    </div>

    <script>
        // Datos del markmap (contenido del archivo markdown)
        const markdownContent = `# POS Cesariel - Sistema Completo

## üèóÔ∏è Arquitectura Principal

### Frontend Applications
- **POS Admin Frontend**
  - Next.js 15 + React 19
  - Puerto: 3000
  - TailwindCSS + Headless UI
  - Zustand (State Management)
  - React Query (API Caching)
- **E-commerce Store**
  - Next.js 15 + React 19
  - Puerto: 3001
  - TailwindCSS + Radix UI
  - React Context (Cart/Customer)
  - Custom Data Service

### Backend API
- **FastAPI Framework**
  - Puerto: 8000
  - Python 3.9+
  - JWT Authentication
  - Role-based Access Control
- **11 Router Modules**
  - auth.py (Authentication)
  - users.py (User Management)
  - branches.py (Multi-branch)
  - products.py (Inventory)
  - sales.py (Sales & Reports)
  - categories.py (Product Categories)
  - config.py (System Configuration)
  - ecommerce_advanced.py (Admin E-commerce)
  - ecommerce_public.py (Public Store API)
  - content_management.py (CMS & Banners)
  - websockets.py (Real-time Updates)

### Database Layer
- **PostgreSQL 15**
  - Puerto: 5432
  - SQLAlchemy ORM
  - Automated Migrations
- **Core Models**
  - User (Admin/Manager/Seller/Ecommerce)
  - Branch (Multi-location)
  - Product (Inventory + Variants)
  - Category (Product Organization)
  - Sale (POS + E-commerce)
  - SaleItem (Line Items)
  - ProductSize (Size-based Stock)
  - EcommerceConfig (Store Settings)

### External Integrations
- **Cloudinary**
  - Image Upload & Optimization
  - CDN Delivery
  - Dynamic Transformations
- **WhatsApp Business API**
  - Order Notifications
  - Customer Communication
  - Sales Coordination
- **WebSocket Manager**
  - Real-time Stock Updates
  - Sales Notifications
  - Dashboard Updates
  - Low Stock Alerts

## üéØ Funcionalidades Principales

### Sistema Multi-sucursal
- **Gesti√≥n de Sucursales**
  - Creaci√≥n y configuraci√≥n
  - Usuarios por sucursal
  - Stock por ubicaci√≥n
- **Control de Acceso**
  - Roles diferenciados
  - Permisos granulares
  - Autenticaci√≥n JWT

### Inventario Centralizado
- **Productos**
  - C√≥digo de barras
  - Categorizaci√≥n
  - Im√°genes (Cloudinary)
  - Variantes (talles/colores)
- **Stock Management**
  - Stock por sucursal
  - Movimientos de inventario
  - Alertas de stock bajo
  - Importaci√≥n masiva (CSV/Excel)
- **Sincronizaci√≥n**
  - POS ‚Üî E-commerce
  - Tiempo real
  - Validaci√≥n de stock

### Sistema de Ventas
- **POS Physical**
  - Interface t√°ctil
  - B√∫squeda r√°pida
  - M√∫ltiples m√©todos de pago
  - Carrito interactivo
- **E-commerce Online**
  - Cat√°logo p√∫blico
  - Carrito de compras
  - Checkout integrado
  - √ìrdenes ‚Üí POS system
- **Reporting**
  - Dashboard en tiempo real
  - Reportes por per√≠odo
  - Productos m√°s vendidos
  - An√°lisis por sucursal

## üì± POS Admin Frontend

### P√°ginas Principales
- **Dashboard**
  - M√©tricas en tiempo real
  - Ventas del d√≠a/mes
  - Stock alerts
  - Acciones r√°pidas
- **POS System**
  - Interface de ventas
  - B√∫squeda de productos
  - Carrito de compras
  - Procesamiento de pagos
- **Inventory Management**
  - CRUD de productos
  - Gesti√≥n de categor√≠as
  - Control de stock
  - Importaci√≥n masiva
- **Reports & Analytics**
  - Dashboard de m√©tricas
  - Reportes personalizables
  - Gr√°ficos interactivos
  - Exportaci√≥n de datos
- **User Management**
  - CRUD usuarios
  - Asignaci√≥n de roles
  - Gesti√≥n de sucursales
  - Control de permisos
- **System Settings**
  - Configuraci√≥n general
  - M√©todos de pago
  - Configuraci√≥n e-commerce
  - Redes sociales
  - Banners de tienda

### Componentes Clave
- **Layout System**
  - Navigation sidebar
  - Header with user info
  - Responsive design
- **Modals & Forms**
  - ImportModal (CSV/Excel)
  - SizeStockModal (Inventory)
  - User forms with validation
- **Data Visualization**
  - Charts (Recharts)
  - Real-time updates
  - Interactive dashboards

## üõçÔ∏è E-commerce Frontend

### P√°ginas P√∫blicas
- **Homepage**
  - Hero banners
  - Featured products
  - Categories showcase
  - Store information
- **Product Catalog**
  - Product grid/list
  - Category filtering
  - Search functionality
  - Pagination
- **Product Details**
  - Image gallery
  - Size/color selection
  - Stock validation
  - Add to cart
- **Shopping Cart**
  - Cart items management
  - Quantity updates
  - Stock validation
  - Checkout process
- **Customer Pages**
  - About us
  - Contact information
  - Store policies

### Context & State Management
- **EcommerceContext**
  - Store configuration
  - Product catalog
  - API integration
- **CartContext**
  - Shopping cart state
  - Customer information
  - Checkout process
- **API Integration**
  - Real-time stock checks
  - Order creation
  - POS system sync

## üóÑÔ∏è Database Schema

### User Management
- **User Model**
  - id, username, email
  - password_hash, role
  - branch_id (FK)
  - created_at, is_active
- **Branch Model**
  - id, name, address
  - phone, email
  - is_active, created_at
- **Roles**
  - ADMIN (Full access)
  - MANAGER (Branch management)
  - SELLER (POS only)
  - ECOMMERCE (Online store)

### Product Management
- **Product Model**
  - id, name, code, barcode
  - price, stock, category_id
  - show_in_ecommerce
  - created_at, updated_at
- **Category Model**
  - id, name, description
  - is_active, created_at
- **ProductSize Model**
  - id, product_id, branch_id
  - size, stock
  - updated_at

### Sales System
- **Sale Model**
  - id, sale_number
  - total_amount, sale_type
  - payment_method
  - seller_id, branch_id
  - sale_date, order_status
- **SaleItem Model**
  - id, sale_id, product_id
  - quantity, unit_price
  - subtotal, size

### E-commerce Configuration
- **EcommerceConfig Model**
  - store_name, description
  - whatsapp_number
  - store_active
- **StoreBanner Model**
  - title, description
  - image_url, link_url
  - active, display_order

## üîÑ Flujos de Datos

### Venta POS
- **B√∫squeda de Productos**
  - Usuario ‚Üí POS Frontend
  - API: GET /products
  - Database query with stock
  - Response with available products
- **Agregar al Carrito**
  - Stock validation
  - Real-time availability check
  - Cart state update
- **Procesar Venta**
  - API: POST /sales
  - Database transaction
  - Stock update
  - Inventory movement record
  - WebSocket notification
  - E-commerce sync

### Compra E-commerce
- **Cat√°logo de Productos**
  - Cliente ‚Üí E-commerce Store
  - API: GET /ecommerce/products
  - Filter: show_in_ecommerce=true
  - Product display with stock
- **Agregar al Carrito**
  - Stock validation API call
  - Cart context update
  - Size/color selection
- **Checkout Process**
  - Customer information
  - API: POST /sales (type=ECOMMERCE)
  - POS system integration
  - WhatsApp notification
  - Order confirmation

## üöÄ Deployment & DevOps

### Docker Compose Architecture
- **Services**
  - frontend (POS Admin :3000)
  - ecommerce (Store :3001)
  - backend (FastAPI :8000)
  - db (PostgreSQL :5432)
  - adminer (DB Admin :8080)
- **Networks**
  - pos-cesariel-network (bridge)
- **Volumes**
  - postgres_data (persistence)
  - Code volumes for development

### Development Commands
- **Primary Commands**
  - make dev (Start all services)
  - make down (Stop all services)
  - make logs-* (Service logs)
  - make shell-* (Container access)
- **Database Setup**
  - python init_data.py (Seed data)
  - Test users: admin/manager/seller
- **Service URLs**
  - POS Admin: localhost:3000
  - E-commerce: localhost:3001
  - API Docs: localhost:8000/docs
  - DB Admin: localhost:8080

## üß™ Testing Strategy

### Backend Testing (Python)
- **pytest Framework**
  - Unit tests
  - Integration tests
  - API endpoint tests
  - Database tests
  - Authentication tests
- **Coverage**
  - 80%+ code coverage
  - HTML reports
  - CI/CD integration

### Frontend Testing
- **POS Admin**
  - Jest (Unit tests)
  - React Testing Library
  - Cypress (E2E tests)
  - Lighthouse (Performance)
  - Artillery (Load tests)
- **E-commerce**
  - Jest (Unit tests)
  - Cypress (E2E tests)
  - Shopping flow tests
  - Integration tests

### Test Data
- **Automated Seeding**
  - init_data.py script
  - Sample products/categories
  - Test users with roles
  - Realistic data volumes

## üîß Technical Stack Summary

### Languages & Frameworks
- **Backend**: Python 3.9+ (FastAPI, SQLAlchemy, Pydantic)
- **Frontend**: TypeScript (Next.js 15, React 19)
- **Database**: PostgreSQL 15
- **Styling**: TailwindCSS
- **Testing**: pytest, Jest, Cypress

### Key Libraries
- **Backend**
  - fastapi, uvicorn, sqlalchemy
  - python-jose (JWT)
  - passlib (Password hashing)
  - cloudinary (Image management)
  - pandas (Data processing)
- **Frontend**
  - axios (HTTP client)
  - react-query (Caching)
  - zustand (State management)
  - recharts (Data visualization)
  - react-hook-form (Forms)

### Infrastructure
- **Containerization**: Docker + Docker Compose
- **Development**: Hot reload, live updates
- **Production**: Nginx, SSL, monitoring
- **CI/CD**: Automated testing, deployment`;

        let mm; // Variable global para el markmap
        let svg; // Variable global para el SVG
        
        // Funci√≥n para inicializar el markmap
        async function initMarkmap() {
            try {
                const { markmap } = window;
                const { Transformer } = markmap;
                const { Markmap, loadCSS, loadJS } = markmap;

                const transformer = new Transformer();
                const { root, features } = transformer.transform(markdownContent);
                
                // Cargar CSS y JS necesarios
                const { styles, scripts } = transformer.getUsedAssets(features);
                if (styles) loadCSS(styles);
                if (scripts) loadJS(scripts);

                // Crear el markmap
                svg = d3.select('#markmap').append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%');
                    
                mm = Markmap.create(svg.node(), {
                    autoFit: true,
                    pan: true,
                    zoom: true,
                    color: (node) => {
                        const colors = [
                            '#4FC3F7', '#42A5F5', '#2196F3', '#1976D2',
                            '#FF7043', '#FF5722', '#E64A19', '#D84315',
                            '#66BB6A', '#4CAF50', '#388E3C', '#2E7D32',
                            '#FFA726', '#FF9800', '#F57C00', '#E65100',
                            '#AB47BC', '#9C27B0', '#7B1FA2', '#4A148C',
                            '#26C6DA', '#00BCD4', '#0097A7', '#006064'
                        ];
                        return colors[node.depth % colors.length];
                    },
                    paddingX: 8,
                    spacingVertical: 5,
                    spacingHorizontal: 80,
                    initialExpandLevel: 2
                }, root);

                // Ocultar loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error inicializando markmap:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="text-align: center; color: #ff6b6b;"><h3>‚ùå Error al cargar el mapa</h3><p>Por favor, recarga la p√°gina</p></div>';
            }
        }

        // Funciones de control
        function expandAll() {
            if (mm) {
                mm.rescale(1.2);
                mm.fit();
            }
        }

        function collapseAll() {
            if (mm) {
                mm.rescale(0.8);
            }
        }

        function resetZoom() {
            if (mm) {
                mm.fit();
            }
        }

        function downloadSVG() {
            if (svg) {
                const svgElement = svg.node();
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgElement);
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'pos-cesariel-architecture-map.svg';
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        // Inicializar cuando se cargue la p√°gina
        window.addEventListener('load', () => {
            setTimeout(initMarkmap, 500); // Peque√±o delay para asegurar que las librer√≠as est√©n cargadas
        });

        // Ocultar instrucciones despu√©s de 10 segundos
        setTimeout(() => {
            const instructions = document.querySelector('.instructions');
            if (instructions) {
                instructions.style.opacity = '0';
                instructions.style.transition = 'opacity 1s ease';
                setTimeout(() => {
                    instructions.style.display = 'none';
                }, 1000);
            }
        }, 10000);
    </script>
</body>
</html>